// Import Firebase modules
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, push, set } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

// Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyAftSnrCDt34hbl0_HCOfFB9ehUdiXL3sw",
    authDomain: "onecard-ce39b.firebaseapp.com",
    databaseURL: "https://onecard-ce39b-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "onecard-ce39b",
    storageBucket: "onecard-ce39b.firebasestorage.app",
    messagingSenderId: "163529886210",
    appId: "1:163529886210:web:76196a43671fec10afb51b"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const database = getDatabase(app);

// Current step
let currentStep = 1;

// Store form data
const formData = {
    personalInfo: {},
    shippingInfo: {},
    paymentMethod: '',
    orderDetails: {
        package: 'Basic Package',
        packagePrice: 100,
        shippingPrice: 20,
        totalPrice: 120
    }
};

// ==================== INITIALIZE EVENT LISTENERS ====================
// Modules load after DOM, so we can attach directly
console.log('Order system loading...');

// Wait a bit to ensure DOM is ready
setTimeout(function() {
    console.log('Attaching button listeners...');

    // Get all buttons with data attributes
    const nextButtons = document.querySelectorAll('button[data-next-step]');
    const prevButtons = document.querySelectorAll('button[data-prev-step]');
    const confirmButton = document.querySelector('button[data-confirm-order]');

    console.log('Found buttons:', {
        next: nextButtons.length,
        prev: prevButtons.length,
        confirm: confirmButton ? 1 : 0
    });

    // Attach next step buttons
    nextButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const step = parseInt(this.getAttribute('data-next-step'));
            console.log('Next button clicked, going to step:', step);
            nextStep(step);
        });
    });

    // Attach previous step buttons
    prevButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const step = parseInt(this.getAttribute('data-prev-step'));
            console.log('Prev button clicked, going to step:', step);
            prevStep(step);
        });
    });

    // Attach confirm button
    if (confirmButton) {
        confirmButton.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Confirm button clicked');
            confirmOrder();
        });
    }

    console.log('All button listeners attached successfully!');
}, 100);

// ==================== STEP NAVIGATION ====================
function nextStep(step) {
    console.log('Next step:', step, 'Current:', currentStep);

    // Validate current step before proceeding
    if (!validateStep(currentStep)) {
        return;
    }

    // Save current step data
    saveStepData(currentStep);

    // Move to next step
    currentStep = step;
    showStep(step);
    updateProgress(step);
}

function prevStep(step) {
    console.log('Previous step:', step);
    currentStep = step;
    showStep(step);
    updateProgress(step);
}

function showStep(step) {
    // Hide all steps
    document.querySelectorAll('.form-step').forEach(s => {
        s.classList.remove('active');
    });

    // Show current step
    const stepElement = document.getElementById('step' + step);
    if (stepElement) {
        stepElement.classList.add('active');
    }

    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function updateProgress(step) {
    // Update progress bar
    const progress = ((step - 1) / 3) * 100;
    document.getElementById('progressFill').style.width = progress + '%';

    // Update progress steps
    document.querySelectorAll('.progress-step').forEach((s, index) => {
        if (index + 1 <= step) {
            s.classList.add('active');
        } else {
            s.classList.remove('active');
        }
    });
}

// ==================== VALIDATION ====================
function validateStep(step) {
    const stepElement = document.getElementById('step' + step);
    const inputs = stepElement.querySelectorAll('input[required]');
    let isValid = true;

    inputs.forEach(input => {
        if (!input.value.trim()) {
            input.classList.add('error');
            isValid = false;

            // Remove error class after user starts typing
            input.addEventListener('input', function() {
                this.classList.remove('error');
            }, { once: true });
        } else {
            input.classList.remove('error');
        }
    });

    // Check radio buttons for payment step
    if (step === 3) {
        const paymentSelected = document.querySelector('input[name="payment"]:checked');
        if (!paymentSelected) {
            showNotification('Please select a payment method', 'error');
            return false;
        }
    }

    if (!isValid) {
        showNotification('Please fill in all required fields', 'error');
    }

    return isValid;
}

// ==================== SAVE STEP DATA ====================
function saveStepData(step) {
    if (step === 1) {
        // Personal Information
        formData.personalInfo = {
            fullName: document.getElementById('fullName').value,
            phone: document.getElementById('phone').value,
            email: document.getElementById('email').value,
            telegram: document.getElementById('telegram').value
        };
    } else if (step === 2) {
        // Shipping Information
        formData.shippingInfo = {
            address: document.getElementById('address').value,
            city: document.getElementById('city').value,
            postalCode: document.getElementById('postalCode').value,
            state: document.getElementById('state').value,
            country: document.getElementById('country').value
        };
    } else if (step === 3) {
        // Payment Method
        const paymentMethod = document.querySelector('input[name="payment"]:checked');
        formData.paymentMethod = paymentMethod ? paymentMethod.value : '';

        // Update confirmation page
        updateConfirmationPage();
    }
}

// ==================== UPDATE CONFIRMATION PAGE ====================
function updateConfirmationPage() {
    // Personal Info
    document.getElementById('confirmName').textContent = formData.personalInfo.fullName;
    document.getElementById('confirmPhone').textContent = formData.personalInfo.phone;
    document.getElementById('confirmEmail').textContent = formData.personalInfo.email;
    document.getElementById('confirmTelegram').textContent = formData.personalInfo.telegram;

    // Shipping Info
    document.getElementById('confirmAddress').textContent = formData.shippingInfo.address;
    document.getElementById('confirmCity').textContent = formData.shippingInfo.city;
    document.getElementById('confirmPostal').textContent = formData.shippingInfo.postalCode;
    document.getElementById('confirmState').textContent = formData.shippingInfo.state;
    document.getElementById('confirmCountry').textContent = formData.shippingInfo.country;

    // Payment Method
    document.getElementById('confirmPayment').textContent = formData.paymentMethod;
}

// ==================== CONFIRM ORDER ====================
async function confirmOrder() {
    try {
        // Generate order code
        const orderCode = generateOrderCode();

        // Prepare order data for Firebase
        const orderData = {
            orderCode: orderCode,
            personalInfo: formData.personalInfo,
            shippingInfo: formData.shippingInfo,
            paymentMethod: formData.paymentMethod,
            orderDetails: formData.orderDetails,
            orderDate: new Date().toISOString(),
            status: 'Pending',
            orderStatus: 'Waiting to Pay Delivery' // New 4-tier status system
        };

        // Save to Firebase
        const ordersRef = ref(database, 'orders');
        const newOrderRef = push(ordersRef);
        await set(newOrderRef, orderData);

        // Show success page
        document.getElementById('orderCode').textContent = orderCode;
        document.getElementById('successEmail').textContent = formData.personalInfo.email;

        // Hide step 4, show success
        document.getElementById('step4').classList.remove('active');
        document.getElementById('stepSuccess').classList.add('active');

        // Update progress to 100%
        document.getElementById('progressFill').style.width = '100%';

        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });

        showNotification('Order placed successfully!', 'success');

    } catch (error) {
        console.error('Error saving order:', error);
        showNotification('Failed to place order. Please try again.', 'error');
    }
}

// ==================== GENERATE ORDER CODE ====================
function generateOrderCode() {
    const prefix = '1CARD';
    const timestamp = Date.now().toString(36).toUpperCase();
    const random = Math.random().toString(36).substring(2, 6).toUpperCase();
    return `${prefix}-${timestamp}-${random}`;
}

// ==================== NOTIFICATION SYSTEM ====================
function showNotification(message, type = 'info') {
    // Create notification container if it doesn't exist
    let notificationContainer = document.getElementById('notificationContainer');
    if (!notificationContainer) {
        notificationContainer = document.createElement('div');
        notificationContainer.id = 'notificationContainer';
        notificationContainer.style.cssText = `
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 10000;
            max-width: 400px;
        `;
        document.body.appendChild(notificationContainer);
    }

    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.style.cssText = `
        background-color: ${getNotificationColor(type)};
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        animation: slideInRight 0.3s ease-out;
        display: flex;
        align-items: center;
        gap: 1rem;
    `;

    // Add icon
    const icon = document.createElement('i');
    icon.className = `fas ${getNotificationIcon(type)}`;
    notification.appendChild(icon);

    // Add message
    const messageSpan = document.createElement('span');
    messageSpan.textContent = message;
    notification.appendChild(messageSpan);

    // Add to container
    notificationContainer.appendChild(notification);

    // Remove notification after 4 seconds
    setTimeout(function() {
        notification.style.animation = 'slideOutRight 0.3s ease-out';
        setTimeout(function() {
            notification.remove();
        }, 300);
    }, 4000);
}

function getNotificationColor(type) {
    const colors = {
        success: '#d4af37',
        error: '#f44336',
        warning: '#ff9800',
        info: '#d4af37'
    };
    return colors[type] || colors.info;
}

function getNotificationIcon(type) {
    const icons = {
        success: 'fa-check-circle',
        error: 'fa-exclamation-circle',
        warning: 'fa-exclamation-triangle',
        info: 'fa-info-circle'
    };
    return icons[type] || icons.info;
}

// ==================== ANIMATION STYLES ====================
const style = document.createElement('style');
style.textContent = `
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes slideOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }

    input.error {
        border-color: #f44336 !important;
        box-shadow: 0 0 0 3px rgba(244, 67, 54, 0.1) !important;
    }
`;
document.head.appendChild(style);

console.log('Order system initialized');
